<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- AutoTools Web Screen Variable (JS) -->
  <meta name="autotoolswebscreen"
        type="variablejs"
        id="tasks_b64"
        label="Tasks JSON Base64"
        description="Base64-encoded JSON of tasks (object keyed by task id)."
        defaultValue="" />

  <title>Tasks</title>

  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b1220; color:#e7eefc; }
    .wrap { padding:16px; max-width: 980px; margin: 0 auto; }
    h1 { margin: 6px 0 14px; font-size: 34px; font-weight: 700; letter-spacing:.2px; }
    .card { background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); border-radius: 16px; padding: 14px; margin: 10px 0; }
    .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .pill { padding:6px 10px; border-radius: 999px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); font-size: 12px; }
    .pill.ok { background: rgba(70,175,74,.15); border-color: rgba(70,175,74,.35); }
    .pill.bad { background: rgba(235,87,87,.14); border-color: rgba(235,87,87,.35); }
    .btn { background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:#e7eefc; padding:10px 12px; border-radius: 12px; font-size: 14px; }
    .btn:active { transform: translateY(1px); }
    input[type="text"]{ width:100%; box-sizing:border-box; background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.12); color:#e7eefc; padding:12px 12px; border-radius: 12px; font-size: 15px; outline: none; }
    .muted { color: rgba(231,238,252,.7); font-size: 13px; }
    table { width:100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 10px 8px; border-bottom: 1px solid rgba(255,255,255,.08); vertical-align: top; }
    th { text-align:left; font-size: 12px; letter-spacing:.12em; text-transform: uppercase; color: rgba(231,238,252,.7); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    pre { white-space: pre-wrap; word-break: break-word; margin: 0; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 10px; }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Tasks</h1>

    <div class="card">
      <div class="row">
        <span id="injectPill" class="pill bad">⛔ tasks_b64 NOT received</span>
        <span class="pill">Tasks: <b id="tasksCount">0</b></span>
        <button class="btn" id="btnToggleRaw" type="button">Show raw JSON</button>
      </div>
      <div class="muted" style="margin-top:8px;">
        Tip: variables only inject when loaded via URL (not local file).
      </div>
    </div>

    <div class="card">
      <div class="muted" style="margin-bottom:8px;">Search (title / status / project)</div>
      <input id="search" type="text" placeholder="Search..." />
    </div>

    <div class="card">
      <div class="muted" style="margin-bottom:8px;">tasks_b64 (first 160 chars)</div>
      <div class="mono">
        <pre id="b64Preview"></pre>
        <div class="muted mono" id="b64Len"></div>
      </div>
    </div>

    <div class="card" id="rawCard" style="display:none;">
      <div class="muted" style="margin-bottom:8px;">Decoded JSON (first 2000 chars)</div>
      <div class="mono"><pre id="rawJson"></pre></div>
    </div>

    <div class="card">
      <div class="muted" style="margin-bottom:8px;">Tasks table (first 200 shown, filtered)</div>
      <table>
        <thead>
          <tr>
            <th>TITLE</th>
            <th>STATUS</th>
            <th>DUE</th>
            <th>PROJECT</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="4" class="muted">No tasks loaded.</td></tr>
        </tbody>
      </table>
    </div>

    <!-- DEBUG CARD -->
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="muted">Debug timeline</div>
        <button class="btn" id="btnClearDebug" type="button">Clear</button>
      </div>
      <div class="mono" style="margin-top:8px;">
        <pre id="debug"></pre>
      </div>
    </div>
  </div>

<script>
/** -------------------------
 *  Debug helpers
 *  ------------------------- */
const T0 = performance.now();
function dbg(label, extra) {
  const ms = Math.round(performance.now() - T0);
  const line = extra !== undefined ? `${ms}ms  ${label}  → ${extra}` : `${ms}ms  ${label}`;
  const el = document.getElementById("debug");
  if (el) el.textContent += (el.textContent ? "\n" : "") + line;
}
window.addEventListener("error", (e) => dbg("window.error", e.message || String(e.error || e)));
window.addEventListener("unhandledrejection", (e) => dbg("unhandledrejection", (e.reason && e.reason.message) ? e.reason.message : String(e.reason)));

dbg("script start");
dbg("document.readyState", document.readyState);

/** -------------------------
 *  Base64 decode safe for UTF-8 JSON
 *  ------------------------- */
function base64ToUtf8(b64) {
  // remove whitespace/newlines that some automation tools may inject
  const clean = (b64 || "").replace(/\s+/g, "");
  // atob -> binary string -> Uint8Array -> TextDecoder
  const bin = atob(clean);
  const bytes = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
  return new TextDecoder("utf-8").decode(bytes);
}

/** -------------------------
 *  Parse tasks payload
 *  Accepts either:
 *   A) { "123": {task...}, "456": {task...} }
 *   B) { success:true, data:[ {...}, {...} ] }
 *  ------------------------- */
function normalizeTasks(parsed) {
  // Case B: wrapper with data array
  if (parsed && Array.isArray(parsed.data)) {
    const out = {};
    for (const t of parsed.data) {
      const id = String(t.id ?? t.url?.id ?? "");
      if (!id) continue;
      out[id] = t;
    }
    return out;
  }
  // Case A: already keyed object
  if (parsed && typeof parsed === "object" && !Array.isArray(parsed)) {
    return parsed;
  }
  return {};
}

function safeText(x) {
  if (x === null || x === undefined) return "";
  return String(x);
}

function getTaskProjectName(task) {
  // Support both shapes you showed
  return safeText(task.project?.name || task.url?.projectName || "");
}
function getTaskProjectId(task) {
  return safeText(task.project?.id || task.url?.projectID || "");
}
function getTaskStatus(task) {
  return safeText(task.status?.label || task.status?.value || task.status || "");
}
function getTaskDue(task) {
  return safeText(task.dueDate || "");
}

let TASKS_OBJ = {};
let TASKS_ARR = [];

/** -------------------------
 *  Render (fast: one innerHTML assignment)
 *  ------------------------- */
function renderTable(filterText) {
  dbg("render start", `filter="${filterText || ""}"`);
  const q = (filterText || "").trim().toLowerCase();

  const filtered = !q ? TASKS_ARR : TASKS_ARR.filter(t => {
    const title = safeText(t.title || t.name || "");
    const status = getTaskStatus(t);
    const proj = getTaskProjectName(t);
    return (title + " " + status + " " + proj).toLowerCase().includes(q);
  });

  const shown = filtered.slice(0, 200);

  const tbody = document.getElementById("tbody");
  if (!tbody) return;

  if (shown.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" class="muted">No tasks loaded.</td></tr>`;
    dbg("render done", "0 rows");
    return;
  }

  const rows = shown.map(t => {
    const id = safeText(t.id || t.url?.id || "");
    const title = safeText(t.title || t.name || "(no title)");
    const status = getTaskStatus(t);
    const due = getTaskDue(t);
    const projName = getTaskProjectName(t);
    const projId = getTaskProjectId(t);

    const projCell = projName ? `${projName}${projId ? ` <span class="muted mono">(#${projId})</span>` : ""}` : `<span class="muted">—</span>`;
    return `
      <tr>
        <td>
          <div><b>${escapeHtml(title)}</b></div>
          <div class="muted mono">id: ${escapeHtml(id)}</div>
        </td>
        <td>${escapeHtml(status || "—")}</td>
        <td class="mono">${escapeHtml(due || "—")}</td>
        <td>${projCell}</td>
      </tr>
    `;
  }).join("");

  tbody.innerHTML = rows;
  dbg("render done", `${shown.length} rows (of ${filtered.length})`);
}

function escapeHtml(str) {
  return safeText(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

/** -------------------------
 *  Main load
 *  ------------------------- */
function loadTasksFromInjectedVariable() {
  dbg("variable read start");
  const b64 = (typeof tasks_b64 !== "undefined") ? tasks_b64 : "";
  dbg("variable read end", `len=${(b64 || "").length}`);

  // show b64 preview + len
  document.getElementById("b64Preview").textContent = (b64 || "").slice(0, 160) || "{tasks_b64}";
  document.getElementById("b64Len").textContent = "len: " + (b64 || "").length;

  const injected = b64 && b64.trim() && b64.indexOf("{tasks_b64}") === -1;
  const pill = document.getElementById("injectPill");
  pill.className = "pill " + (injected ? "ok" : "bad");
  pill.textContent = injected ? "✅ tasks_b64 received" : "⛔ tasks_b64 NOT received";

  if (!injected) {
    dbg("stop", "no injected variable");
    return;
  }

  let jsonText = "";
  try {
    dbg("base64 decode start");
    jsonText = base64ToUtf8(b64);
    dbg("base64 decode end", `jsonChars=${jsonText.length}`);
  } catch (e) {
    dbg("decode error", e.message || String(e));
    showParseError("Base64 decode failed: " + (e.message || e));
    return;
  }

  // raw JSON preview (lazy displayed; still store a short preview)
  const rawPreview = jsonText.slice(0, 2000);
  document.getElementById("rawJson").textContent = rawPreview;

  let parsed;
  try {
    dbg("JSON.parse start");
    parsed = JSON.parse(jsonText);
    dbg("JSON.parse end");
  } catch (e) {
    dbg("JSON.parse failed", e.message || String(e));
    showParseError("JSON parse failed: " + (e.message || e));
    return;
  }

  dbg("normalize start");
  TASKS_OBJ = normalizeTasks(parsed);
  dbg("normalize end", `keys=${Object.keys(TASKS_OBJ).length}`);

  TASKS_ARR = Object.keys(TASKS_OBJ).map(k => {
    const t = TASKS_OBJ[k] || {};
    // ensure id exists (use key if missing)
    if (!t.id) t.id = k;
    return t;
  });

  document.getElementById("tasksCount").textContent = TASKS_ARR.length;

  // first render
  renderTable(document.getElementById("search").value);
}

function showParseError(msg) {
  const pill = document.getElementById("injectPill");
  pill.className = "pill bad";
  pill.textContent = "⛔ " + msg;
}

/** -------------------------
 *  UI wiring
 *  ------------------------- */
document.getElementById("btnToggleRaw").addEventListener("click", () => {
  const card = document.getElementById("rawCard");
  const isHidden = card.style.display === "none";
  card.style.display = isHidden ? "block" : "none";
});

document.getElementById("btnClearDebug").addEventListener("click", () => {
  document.getElementById("debug").textContent = "";
  dbg("debug cleared");
});

document.getElementById("search").addEventListener("input", (e) => {
  // debounce lightly to reduce re-render cost
  if (window.__t) clearTimeout(window.__t);
  window.__t = setTimeout(() => renderTable(e.target.value), 80);
});

/** -------------------------
 *  Run
 *  ------------------------- */
dbg("before loadTasks()");
loadTasksFromInjectedVariable();
dbg("after loadTasks()");
</script>

</body>
</html>