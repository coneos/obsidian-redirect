<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AutoTools Variable Test</title>

  <!-- AutoTools Web Screen Variables -->
  <!-- IMPORTANT: this is what makes AutoTools replace the variables when loaded via URL -->
  <meta name="autotoolswebscreen" content="variables" />
  <meta name="autotoolsvariable" content="projects_b64" />

  <style>
    :root {
      --bg: #0b0f14;
      --panel: #0f1620;
      --text: #d7e2f0;
      --muted: #8aa0b8;
      --ok: #43d17a;
      --bad: #ff5b5b;
      --border: rgba(255,255,255,.08);
    }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      padding:18px;
    }
    h1{
      margin:0 0 10px 0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .row{ display:flex; align-items:center; gap:10px; margin:10px 0 14px; }
    .pill{
      display:inline-block;
      padding:6px 10px;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    .ok{ color:var(--ok); }
    .bad{ color:var(--bad); }
    .box{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      margin:12px 0;
    }
    .label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    pre{
      margin:0;
      white-space:pre-wrap;
      word-break:break-word;
      font-size:12px;
      line-height:1.35;
      color:#cfe3ff;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th, td{
      border-bottom:1px solid var(--border);
      padding:8px 6px;
      text-align:left;
      vertical-align:top;
    }
    th{ color:var(--muted); font-weight:600; }
    a{ color:#7fb7ff; text-decoration:none; }
    .small{ font-size:11px; color:var(--muted); }
    button{
      background:transparent;
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      font-family:inherit;
      font-size:12px;
    }
  </style>
</head>

<body>
  <h1>AutoTools Variable Test</h1>

  <div class="row">
    <span id="statusIcon" class="pill">⏳</span>
    <span id="statusText" class="pill">waiting for projects_b64…</span>
    <span id="countPill" class="pill">Projects: 0</span>
  </div>

  <div class="box">
    <div class="label">projects_b64 (first 140 chars)</div>
    <pre id="b64Preview">—</pre>
    <div class="small" id="b64Len">length: 0</div>
  </div>

  <div class="box">
    <div class="label">Decoded JSON preview (first 1200 chars)</div>
    <pre id="jsonPreview">—</pre>
    <div class="small" id="jsonLen">length: 0</div>
  </div>

  <div class="box">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="label" style="margin:0;">Projects table (first 25)</div>
        <div class="small">name • status • dueDate • progress</div>
      </div>
      <button id="toggleBtn" type="button">Show raw JSON</button>
    </div>

    <div id="tableWrap"></div>

    <div id="rawWrap" style="display:none; margin-top:12px;">
      <pre id="rawJson">—</pre>
    </div>
  </div>

  <script>
    // AutoTools will replace this with your variable value (Base64 string)
    // If it's empty, variables aren't being injected (usually means not loaded via URL).
    var projects_b64 = "{projects_b64}";

    function setStatus(ok, msg) {
      var icon = document.getElementById("statusIcon");
      var text = document.getElementById("statusText");
      if (ok) {
        icon.textContent = "✅";
        icon.className = "pill ok";
        text.className = "pill ok";
      } else {
        icon.textContent = "❌";
        icon.className = "pill bad";
        text.className = "pill bad";
      }
      text.textContent = msg;
    }

    // Base64 decode (ASCII-safe because we encoded UTF-8 ourselves on MacroDroid side)
    function b64ToUtf8String(b64) {
      // atob is available in WebView (AutoTools Web Screen)
      var binary = atob(b64);
      // Convert binary string to percent-encoding then decode
      var esc = "";
      for (var i = 0; i < binary.length; i++) {
        var code = binary.charCodeAt(i).toString(16).padStart(2, "0");
        esc += "%" + code;
      }
      return decodeURIComponent(esc);
    }

    function safeJsonParse(s) {
      try { return { ok:true, value: JSON.parse(s) }; }
      catch (e) { return { ok:false, error: String(e) }; }
    }

    function renderTable(arr) {
      if (!Array.isArray(arr) || arr.length === 0) {
        document.getElementById("tableWrap").innerHTML =
          '<div class="small">No projects found.</div>';
        return;
      }

      var html = '<table><thead><tr>' +
        '<th>Name</th><th>Status</th><th>Due</th><th>Progress</th><th>Link</th>' +
        '</tr></thead><tbody>';

      var max = Math.min(arr.length, 25);
      for (var i=0; i<max; i++) {
        var p = arr[i] || {};
        var name = (p.name || "").toString();
        var status = (p.status || "").toString();
        var due = (p.dueDate || "").toString();
        var prog = (typeof p.progress === "number" ? (p.progress + "%") : (p.progress || "")).toString();

        // url in your minimized output is like "/p/xxxx"
        var url = (p.url || "").toString();
        var link = url ? '<a href="' + url + '">open</a>' : '';

        html += "<tr>" +
          "<td>" + escapeHtml(name) + "</td>" +
          "<td>" + escapeHtml(status) + "</td>" +
          "<td>" + escapeHtml(due) + "</td>" +
          "<td>" + escapeHtml(prog) + "</td>" +
          "<td>" + link + "</td>" +
          "</tr>";
      }

      html += "</tbody></table>";
      document.getElementById("tableWrap").innerHTML = html;
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    (function init() {
      // Show b64 preview + length
      var b64 = (projects_b64 || "").trim();
      document.getElementById("b64Len").textContent = "length: " + b64.length;
      document.getElementById("b64Preview").textContent = b64 ? b64.substring(0, 140) : "—";

      // Detect if variable injected
      if (!b64 || b64 === "{projects_b64}") {
        setStatus(false, "projects_b64 NOT received (variables not injected)");
        document.getElementById("jsonPreview").textContent =
          "Tip: variables only inject when the HTML is loaded via URL (not local file).";
        return;
      }

      setStatus(true, "projects_b64 received");

      // Decode -> parse -> render
      var jsonText;
      try {
        jsonText = b64ToUtf8String(b64);
      } catch (e) {
        setStatus(false, "Base64 decode failed");
        document.getElementById("jsonPreview").textContent = String(e);
        return;
      }

      document.getElementById("jsonLen").textContent = "length: " + jsonText.length;
      document.getElementById("jsonPreview").textContent = jsonText.substring(0, 1200);

      var parsed = safeJsonParse(jsonText);
      if (!parsed.ok) {
        setStatus(false, "JSON parse failed");
        document.getElementById("jsonPreview").textContent =
          parsed.error + "\n\nPreview:\n" + jsonText.substring(0, 1200);
        return;
      }

      var obj = parsed.value || {};
      var arr = Array.isArray(obj.data) ? obj.data : [];
      document.getElementById("countPill").textContent = "Projects: " + (obj.count || arr.length || 0);

      // Render table + raw JSON toggle
      renderTable(arr);
      document.getElementById("rawJson").textContent = jsonText;

      document.getElementById("toggleBtn").addEventListener("click", function() {
        var rawWrap = document.getElementById("rawWrap");
        var show = rawWrap.style.display === "none";
        rawWrap.style.display = show ? "block" : "none";
        this.textContent = show ? "Hide raw JSON" : "Show raw JSON";
      });
    })();
  </script>
</body>
</html>